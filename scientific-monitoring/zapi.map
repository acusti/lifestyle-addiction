{"version":3,"file":"zapi.js","sources":["zapi-compiled.js"],"names":["$","zapi","js_plugin_src","defaults","collection","user","num_entries","start","zotero_options","params","callback","collection_name","window","location","pathname","split","pop","replace","feed_base","namespace","$body","document","body","$window","$parent_body","$footer","$year_filter","$year_links","$year_sections","quarter_labels","years","total","is_init","load_all","all_loaded","loading_class","year_section_class","loading_indicator_styles","loading_indicator_html","year_heading_styles","year_filter_html","year_filter_styles","tab_height_timeout","fixTabHeight","clearTimeout","setTimeout","off","frameElement","height","tab_height","parent","on","filterByType","type","this","attr","buildParams","options","extend","getFeedUrl","feed_url","Date","toDateString","q","encodeURIComponent","getReferences","prepareMarkup","hasClass","find","append","addClass","prev","className","before","ajax","url","dataType","success","resp","the_month","$entry","$bib","bib_html","bib_url_start","entry","entry_class","$feed","parseXML","responseData","xmlString","$entries","len","length","i","ref_html","the_year","year_class","is_new_year","parseInt","text","parseJSON","filter","push","quarterly","date","getMonth","isNaN","Math","floor","title","children","outerHTML","lastIndexOf","substring","indexOf","loadYearFilterList","year_list","yearFilterToggle","yearFilterTitleToggle","evt","preventDefault","$year_link","active_year","not","removeClass","toggleClass","innerHTML","fadeOut","fadeIn","trigger","each","quarters","$quarters","$year_title","refs_by_quarter","insertAfter","$filter","active_quarter","data","getNextReferences","timedout","stopPropagation","yearFilterAddActive","yearFilterToggleActive","zotero_api","undefined","event","special","inview","href","join","jQuery"],"mappings":"CAAA,SAAUA,GACT,GAAIC,GAAMC,CAEVD,IACCE,UACCC,WAAiB,GACjBC,KAAiB,UAEjBC,YAAiB,GACjBC,MAAiB,EACjBC,eAAiB,+DAElBC,UACAC,YACAC,gBAAkBC,OAAOC,SAASC,SAASC,MAAM,KAAKC,MAAMC,QAAQ,WAAY,IAAIA,QAAQ,cAAe,IAAIA,QAAQ,QAAS,IAChIC,UAAkB,gCAClBC,UAAkB,UAGlBC,MAAiBpB,EAAEqB,SAASC,MAC5BC,QAAiBvB,EAAEY,QACnBY,aAAiBxB,EAAE,QACnByB,QAAiBzB,EAAE,kBACnB0B,aAAiB1B,IACjB2B,YAAiB3B,IACjB4B,eAAiB5B,IAEjB6B,gBACC,cACA,eACA,cACA,aAGDC,SAEAC,OAAa,EAEbC,SAAa,EAEbC,UAAa,EAEbC,YAAa,EAEbC,cAAqB,qBAErBC,mBAAqB,eAErBC,yBAA2B,GAC3BC,uBAA2B,GAC3BC,oBAA2B,GAC3BC,iBAA2B,GAC3BC,mBAA2B,GAE3BC,mBAAoB,GACpBC,aAAc,WACb/B,OAAOgC,aAAa3C,EAAKyC,oBACzBzC,EAAKyC,mBAAqB9B,OAAOiC,WAAW,WAE3C5C,EAAKsB,QAAQuB,IAAI,eAAiB7C,EAAKU,iBAEvCC,OAAOmC,aAAaC,OAAS/C,EAAKgD,WAAahD,EAAKmB,MAAM8B,SAASF,SAAW,GAE9EpC,OAAOiC,WAAW,WACjB5C,EAAKsB,QAAQ4B,GAAG,eAAiBlD,EAAKU,gBAAiBV,EAAK0C,eAC1D,MACD,MAEJS,aAAc,SAASC,GACtB,MAAO,YACN,MAAOrD,GAAEsD,MAAMC,KAAK,eAAiBF,IAGvCG,YAAa,SAASC,GACrBxD,EAAKQ,OAAST,EAAE0D,UAAWzD,EAAKE,SAAUsD,IAE3CE,WAAY,WACX,GAAIC,GAAW3D,EAAKiB,SAYpB,OATA0C,IAAY3D,EAAKQ,OAAOJ,KAAO,gBAAkBJ,EAAKQ,OAAOL,WAAa,UAAYH,EAAKQ,OAAOD,eAAiB,UAAYP,EAAKQ,OAAOF,MAAQ,UAAYN,EAAKQ,OAAOH,YAG3KsD,GAAY,QAAS,GAAIC,OAAOC,eAE5B7D,EAAKQ,OAAOsD,IACfH,GAAY,MAAQ3D,EAAKQ,OAAOsD,EAAI,2BAG9B,4EAA8E9D,EAAKQ,OAAOH,YAAc,MAAQ0D,mBAAmBJ,IAE3IK,cAAe,SAASR,EAAS/C,GAahC,GAXI+C,IAEHxD,EAAKuD,YAAYC,GACb/C,IACHT,EAAKS,SAAWA,IAGdT,EAAK+B,SACR/B,EAAKiE,iBAGFjE,EAAKiC,WAAT,CAIA,GAAI0B,GAAW3D,EAAK0D,YAGf1D,GAAKmB,MAAM+C,SAAS,WACxBnE,EAAEqB,UAAU+C,KAAK,QAAQC,OAAO,UAAYpE,EAAKsC,oBAAsB,KAAOtC,EAAKoC,yBAA2B,KAAOpC,EAAKwC,mBAAqB,YAC/IxC,EAAKmB,MAAMkD,SAAS,UAIoB,YAArCrE,EAAKwB,QAAQ8C,OAAO,GAAGC,YAE1BxE,EAAE,QAAQqE,OAAO,UAAYpE,EAAKoC,yBAA2B,YAE7DpC,EAAKwB,QAAQgD,OAAOxE,EAAKqC,yBAI1BrC,EAAKuB,aAAa8C,SAASrE,EAAKkC,eAChCnC,EAAE0E,MACDC,IAAKf,EACLgB,SAAU,QACVC,QAAS,SAASC,GACjB,GASCC,GACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EAdAC,EAActF,EAAEA,EAAEuF,SAAST,EAAKU,aAAaC,YAC7CC,EAAcJ,EAAMlB,KAAK,SACzBuB,EAAcD,EAASE,OACvBC,EAAc,EACdC,EAAc,GACdC,EAAc,GACdC,EAAc,GACdC,GAAc,CAoBf,KAVIhG,EAAK8B,SAAU,IAElB9B,EAAK8B,MAAQuD,EAAMlB,KAAKnE,EAAKkB,UAAY,gBAEpClB,EAAK8B,MAAM6D,SACf3F,EAAKkB,UAAY,GACjBlB,EAAK8B,MAAQuD,EAAMlB,KAAKnE,EAAKkB,UAAY,iBAE1ClB,EAAK8B,MAAQmE,SAASjG,EAAK8B,MAAMoE,OAAQ,KAE/BR,EAAJE,EAASA,IACfb,EAAShF,EAAE0F,EAASG,IAEpBT,EAAQpF,EAAEoG,UAAUpB,EAAOZ,KAAKnE,EAAKkB,UAAY,cAAckF,OAAOpG,EAAKmD,aAAa,SAAS+C,QAEjGd,EAAc,YAEdU,EAAWf,EAAOZ,KAAKnE,EAAKkB,UAAY,QAAQgF,OAChDF,EAAchG,EAAK6B,MAAM7B,EAAK6B,MAAM8D,OAAS,KAAOG,IAE/CD,EAASF,QAAUK,KAEnBhG,EAAK6B,MAAM8D,QAAUE,EAASF,SACjCE,GAAY,UAEbE,EAAa/F,EAAKmC,mBAAqB,IAAM2D,EAExC9F,EAAK6B,MAAM8D,SACfI,GAAc,UAEfF,GAAY,eAAiBE,EAAa,KAEtCC,IACHH,GAAY,gBAAkBC,EAAW,KAAOA,EAAW,QAC3D9F,EAAK6B,MAAMwE,KAAKP,KAId9F,EAAKQ,OAAO8F,YACfxB,EAAY,GAAIlB,MAAKuB,EAAMoB,MAC3BzB,EAAYA,EAAU0B,WAClBC,MAAM3B,KAETA,EAAY,GAEbM,GAAe,SAAWU,EAAW,YAAcY,KAAKC,MAAM7B,EAAY,IAG3Ee,GAAY,eAAiBT,EAAc,KAE3CS,GAAY,QAAUV,EAAMT,IAAM,YAAcS,EAAMT,IAAM,qBAAuB,IAAMS,EAAMyB,OAASzB,EAAMT,IAAM,OAAS,IAAM,QAEnIM,EAAOD,EAAOZ,KAAKnE,EAAKkB,UAAY,cAAckF,OAAOpG,EAAKmD,aAAa,QAAQ0D,SAAS,OACxF7B,EAAKW,SACRV,EAAWD,EAAK,GAAG8B,UACf3B,EAAMT,MACTQ,EAAgBD,EAAS8B,YAAY,iBACf,KAAlB7B,IACHA,EAAgBD,EAAS8B,YAAY,mBAEhB,KAAlB7B,IAGHA,EAAgBD,EAAS+B,UAAU,EAAG9B,GAAe6B,YAAY,cAC3C,KAAlB7B,IACHD,EAAWA,EAAS+B,UAAU,EAAG9B,GAAiBD,EAAS+B,UAAU/B,EAASgC,QAAQ,cAIzFpB,GAAYZ,GAEbY,GAAY,QAGbA,IAAY,SAER7F,EAAK+B,UACR8D,EAAW7F,EAAKuC,iBAAmBsD,GAMpC7F,EAAKS,SAASoF,GAIV7F,EAAK+B,UAER/B,EAAK+B,SAAU,EAEf/B,EAAKyB,aAAezB,EAAKmB,MAAMgD,KAAK,gBACpCnE,EAAKmB,MAAM+B,GAAG,qBAAuBlD,EAAKU,gBAAiB,eAAgBV,EAAKkH,oBAChFlH,EAAKmB,MAAM+B,GAAG,mBAAqBlD,EAAKU,gBAAiB,WACxD,GACCyG,GAAY,GACZvB,EAAY,EACZF,EAAY1F,EAAK6B,MAAM8D,MAUxB,KAPA3F,EAAKyB,aAAezB,EAAKmB,MAAMgD,KAAK,gBAEpCnE,EAAKmB,MAAM0B,IAAI,qBAAuB7C,EAAKU,iBAAiBwC,GAAG,qBAAuBlD,EAAKU,gBAAiB,eAAgBV,EAAKoH,kBACjIpH,EAAKmB,MAAM0B,IAAI,qBAAuB7C,EAAKU,iBAAiBwC,GAAG,qBAAuBlD,EAAKU,gBAAiB,kBAAmBV,EAAKqH,uBAEpIrH,EAAK2B,eAAiB3B,EAAKmB,MAAMgD,KAAK,IAAMnE,EAAKmC,oBAEtCuD,EAAJE,EAASA,IACX5F,EAAK6B,MAAM+D,GAAGD,SACjBwB,GAAa,wCAA0CnH,EAAK6B,MAAM+D,GAAK,KAAO5F,EAAK6B,MAAM+D,GAAK,YAGhG5F,GAAKyB,aAAa0C,KAAK,UAAUC,OAAO+C,GACxCnH,EAAK0B,YAAc1B,EAAKyB,aAAa0C,KAAK,eAC1CnE,EAAK0B,YAAYwB,GAAG,SAAWlD,EAAKU,gBAAiB,SAAS4G,GAC7DA,EAAIC,gBACJ,IAAIC,GAAczH,EAAEsD,MACnBoE,EAAc,EAGfzH,GAAK0B,YAAYgG,IAAIF,GAAYG,YAAY,UAC7CH,EAAWI,YAAY,UAEnBJ,EAAWtD,SAAS,WACvBuD,EAAc,IAAMpE,KAAKwE,UAMzB7H,EAAKmB,MAAMkD,SAAS,YACpBrE,EAAK2B,eAAe+F,IAAID,GAAaE,YAAY,UAAUG,UAC3D9H,EAAK2B,eAAeyE,OAAOqB,GAAapD,SAAS,UAAU0D,WAE3D/H,EAAKmB,MAAMwG,YAAY,YACvB3H,EAAK2B,eAAeoG,UAIrBpH,OAAOiC,WAAW,WACjB5C,EAAKsB,QAAQ0G,QAAQ,eAAiBhI,EAAKU,kBACzC,OAGJV,EAAKmB,MAAM0B,IAAI,mBAAqB7C,EAAKU,iBAEzCC,OAAOiC,WAAW,WACjB5C,EAAKmB,MAAMwG,YAAY3H,EAAKkC,gBAC1B,IAEClC,EAAKyB,aAAayC,SAAS,WAC9BvD,OAAOiC,WAAW,WACjB5C,EAAKsB,QAAQ0G,QAAQ,eAAiBhI,EAAKU,kBACzC,KAGAV,EAAKQ,OAAO8F,WACftG,EAAKmB,MAAMgD,KAAK,MAAM8D,KAAK,WAC1B,GAECC,GACAC,EAHGC,EAAcrI,EAAEsD,MACnByC,EAAWzC,KAAKwE,UAGhBQ,IAED,IAAKvC,EAASH,OAAd,CAGAuC,EAAW,wBAEX,KAAK,GAAItC,GAAI,EAAO,EAAJA,EAAOA,IACtByC,EAAgBzC,GAAK5F,EAAKmB,MAAMgD,KAAK,IAAMnE,EAAKmC,mBAAqB,IAAM2D,EAAW,aAAeF,GACjGyC,EAAgBzC,GAAGD,SACtBuC,GAAY,8CAAgDtC,EAAI,KAAO5F,EAAK4B,eAAegE,GAAK,UAIlGsC,IAAY,SAEZE,EAAY/D,SAAS,aACrB8D,EAAYpI,EAAEmI,GAAUI,YAAYF,GACpCD,EAAUjF,GAAG,QAAS,kBAAmB,WACxC,GAEC0C,GAFG2C,EAAUxI,EAAEsD,MACfmF,EAAiB,EAMlB,IAHAL,EAAUhE,KAAK,mBAAmBuD,IAAIa,GAASZ,YAAY,UAC3DY,EAAQX,YAAY,UAEhBW,EAAQrE,SAAS,UAEpB,IADAsE,EAAiBvC,SAASsC,EAAQE,KAAK,WAAY,IAC9C7C,EAAI,EAAO,EAAJA,EAAOA,IACdA,IAAM4C,EACTH,EAAgBzC,GAAGkC,UAEnBO,EAAgBzC,GAAGmC,aAIrB,KAAKnC,EAAI,EAAO,EAAJA,EAAOA,IACdA,IAAM4C,GACTH,EAAgBzC,GAAGmC,iBAS3B/H,EAAK+B,SAAU,EACf/B,EAAKuB,aAAaoG,YAAY3H,EAAKkC,eAGnClC,EAAKsB,QAAQ4B,GAAG,eAAiBlD,EAAKU,gBAAiBV,EAAK0C,cAAcsF,QAAQ,eAAiBhI,EAAKU,iBAGpGV,EAAKQ,OAAOF,MAAQN,EAAKQ,OAAOH,YAAcL,EAAK8B,MACtD9B,EAAK0I,qBAEL1I,EAAKiC,YAAa,EAClBjC,EAAKmB,MAAM6G,QAAQ,mBAAqBhI,EAAKU,uBAMjDgI,kBAAmB,SAASC,GAE3B,MAAK3I,GAAKgC,UAAa2G,GAOvB3I,EAAKQ,OAAOF,OAASN,EAAKQ,OAAOH,YAG7BL,EAAKQ,OAAOF,QAAUN,EAAKQ,OAAOH,cACrCL,EAAKQ,OAAOH,YAAc,SAItBL,EAAKgC,SAWThC,EAAKgE,gBAVLhE,EAAKwB,QAAQ0B,GAAG,UAAYlD,EAAKU,gBAAiB,WAE7CX,EAAE,oBAAoBuD,KAAK,QAAUtD,EAAKU,kBAI9CV,EAAKwB,QAAQqB,IAAI,UAAY7C,EAAKU,iBAClCV,EAAKgE,yBArBNrD,QAAOiC,WAAW,WACjB5C,EAAK0I,mBAAkB,IACrB,MAyBLzE,cAAe,WAEdjE,EAAKoC,yBAA2B,mIAAqIpC,EAAKkC,cAAgB,60BAC1LlC,EAAKqC,uBAA2B,2JAChCrC,EAAKsC,oBAA2B,UAAYtC,EAAKmC,mBAAqB,oCAAsCnC,EAAKmC,mBAAqB,uCAAyCnC,EAAKmC,mBAAqB,2BACzMnC,EAAKuC,iBAA2B,wHAA0HvC,EAAKqC,uBAAyB,sBACxLrC,EAAKwC,mBAA2B,6gCAEjC0E,mBAAoB,SAASI,GAK5B,GAJAA,EAAIsB,kBAEJ5I,EAAK6I,uBAEA7I,EAAKiC,WAAY,CACrB,GAAIjC,EAAKgC,SAER,MAGDhC,GAAKgC,UAAW,EAEhBhC,EAAKQ,OAAOH,YAAc,GAE1BL,EAAKmB,MAAMkD,SAASrE,EAAKkC,eAEzBlC,EAAKgE,gBAGNhE,EAAKmB,MAAM0B,IAAI,qBAAuB7C,EAAKU,iBAC3CV,EAAKmB,MAAM+B,GAAG,qBAAuBlD,EAAKU,gBAAiB,eAAgBV,EAAKoH,kBAChFpH,EAAKmB,MAAM+B,GAAG,qBAAuBlD,EAAKU,gBAAiB,kBAAmBV,EAAKqH,wBAEpFD,iBAAkB,SAASE,GAC1BA,EAAIsB,kBAEJ5I,EAAK6I,sBAGLlI,OAAOiC,WAAW,WACjB5C,EAAKsB,QAAQ0G,QAAQ,eAAiBhI,EAAKU,kBACzC,MAEJ2G,sBAAuB,SAASC,GAC/BA,EAAIsB,kBAEJ5I,EAAK8I,yBAGLnI,OAAOiC,WAAW,WACjB5C,EAAKsB,QAAQ0G,QAAQ,eAAiBhI,EAAKU,kBACzC,MAEJmI,oBAAqB,SAASpH,GAE7B,MADAA,GAAeA,GAAgBzB,EAAKmB,MAAMgD,KAAK,gBAC1C1C,EAAayC,SAAS,WAKpB,GAJNzC,EAAa4C,SAAS,UACtB5C,EAAa0C,KAAK,SAASE,SAAS,SAC7B,IAITyE,uBAAwB,SAASrH,GAChCA,EAAeA,GAAgBzB,EAAKmB,MAAMgD,KAAK,gBAC1CnE,EAAK6I,oBAAoBpH,KAC7BA,EAAakG,YAAY,UACzBlG,EAAa0C,KAAK,SAASwD,YAAY,WAY1ChH,OAAOoI,WAAa/I,EAGWgJ,SAA3BjJ,EAAEkJ,MAAMC,QAAQC,SACnBlJ,EAAgBU,OAAOC,SAASwI,KAAKtI,MAAM,KAC3Cb,EAAcc,MACdd,EAAcoG,KAAK,wBACnBrG,EAAKuB,aAAa6C,OAAO,gBAAkBnE,EAAcoJ,KAAK,KAAO,iBAEpE1I,OAAO2I,QAAU3I,OAAOsC,OAAOqG","sourcesContent":["(function($) {\n\tvar zapi, js_plugin_src;\n\n\tzapi = {\n\t\tdefaults : {\n\t\t\tcollection     : '',\n\t\t\tuser           : '1562960',\n\t\t\t// Number of entries to fetch\n\t\t\tnum_entries    : 20,\n\t\t\tstart          : 0,\n\t\t\tzotero_options : 'format=atom&content=json,bib&style=apa&order=date&sort=desc'\n\t\t},\n\t\tparams          : {},\n\t\tcallback        : {},\n\t\tcollection_name : window.location.pathname.split('/').pop().replace('archive-', '').replace('monitoring-', '').replace('.html', ''),\n\t\tfeed_base       : 'https://api.zotero.org/users/',\n\t\tnamespace       : 'zapi\\\\:',\n\t\t// @todo try fetching xml nodes with namespace prefix; if it doesn't work, set namespace prefix to ''\n\t\t// Element cache (careful with using string selectors with this jQuery; it will search the parent DOM)\n\t\t$body          : $(document.body),\n\t\t$window        : $(window),\n\t\t$parent_body   : $('body'),\n\t\t$footer        : $('.c-back-to-top'),\n\t\t$year_filter   : $(),\n\t\t$year_links    : $(),\n\t\t$year_sections : $(),\n\t\t// Labels for quarter-year filters\n\t\tquarter_labels  : [\n\t\t\t'Jan - April',\n\t\t\t'April - June',\n\t\t\t'July - Sept',\n\t\t\t'Oct - Dec'\n\t\t],\n\t\t// An array of years of the references (for archive page)\n\t\tyears      : [],\n\t\t// Total number of references\n\t\ttotal      : false,\n\t\t// Flag if is initial load\n\t\tis_init    : true,\n\t\t// Flag for loading all references immediately\n\t\tload_all   : false,\n\t\t// Flag for keeping track if all references have been loaded\n\t\tall_loaded : false,\n\t\t// Class to add to body when loading references\n\t\tloading_class      : 'loading-references',\n\t\t// Class to add to year sections\n\t\tyear_section_class : 'year-section',\n\t\t// HTML and CSS snippets\n\t\tloading_indicator_styles : '',\n\t\tloading_indicator_html   : '',\n\t\tyear_heading_styles      : '',\n\t\tyear_filter_html         : '',\n\t\tyear_filter_styles       : '',\n\t\t// Set the correct height of the tab iframe\n\t\ttab_height_timeout: '',\n\t\tfixTabHeight: function() {\n\t\t\twindow.clearTimeout(zapi.tab_height_timeout);\n\t\t\tzapi.tab_height_timeout = window.setTimeout(function() {\n\t\t\t\t// Remove this event listener, adjust height, add back the listener\n\t\t\t\tzapi.$window.off('resize.tabs.' + zapi.collection_name);\n\t\t\t\t// Set height with extra 50px\n\t\t\t\twindow.frameElement.height = zapi.tab_height = zapi.$body.parent().height() + 50;\n\t\t\t\t// Add back the listener\n\t\t\t\twindow.setTimeout(function() {\n\t\t\t\t\tzapi.$window.on('resize.tabs.' + zapi.collection_name, zapi.fixTabHeight);\n\t\t\t\t}, 200);\n\t\t\t}, 200);\n\t\t},\n\t\tfilterByType: function(type) {\n\t\t\treturn function() {\n\t\t\t\treturn $(this).attr('zapi:type') === type;\n\t\t\t};\n\t\t},\n\t\tbuildParams: function(options) {\n\t\t\tzapi.params = $.extend({}, zapi.defaults, options);\n\t\t},\n\t\tgetFeedUrl: function() {\n\t\t\tvar feed_url = zapi.feed_base;\n\t\t\t\n\t\t\t// Build the zotero api url\n\t\t\tfeed_url += zapi.params.user + '/collections/' + zapi.params.collection + '/items?' + zapi.params.zotero_options + '&start=' + zapi.params.start + '&limit=' + zapi.params.num_entries;\n\t\t\t\n\t\t\t// Add a 24 hour cache busting date string\n\t\t\tfeed_url += '&cb=' + new Date().toDateString();\n\t\t\t\n\t\t\tif (zapi.params.q) {\n\t\t\t\tfeed_url += '&q=' + zapi.params.q + '&qmode=titleCreatorYear';\n\t\t\t}\n\t\t\t// Build the google feed api url and return it\n\t\t\treturn 'https://ajax.googleapis.com/ajax/services/feed/load?v=1.0&output=xml&num=' + zapi.params.num_entries + '&q=' + encodeURIComponent(feed_url);\n\t\t},\n\t\tgetReferences: function(options, callback) {\n\t\t\t// If we have options (like on first load), use them\n\t\t\tif (options) {\n\t\t\t\t// Build our params, then get the feed url\n\t\t\t\tzapi.buildParams(options);\n\t\t\t\tif (callback) {\n\t\t\t\t\tzapi.callback = callback;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (zapi.is_init) {\n\t\t\t\tzapi.prepareMarkup();\n\t\t\t}\n\t\t\t// If all references are already loaded, return\n\t\t\tif (zapi.all_loaded) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// Get the google feed api url\n\t\t\tvar feed_url = zapi.getFeedUrl();\n\t\t\t\n\t\t\t// Check if the iframe has our styles yet\n\t\t\tif (!zapi.$body.hasClass('ready')) {\n\t\t\t\t$(document).find('head').append('<style>' + zapi.year_heading_styles + '\\n' + zapi.loading_indicator_styles + '\\n' + zapi.year_filter_styles + '</style>');\n\t\t\t\tzapi.$body.addClass('ready');\n\t\t\t}\n\n\t\t\t// If the spinner markup is not yet in the parent.window DOM, set it up and add styles\n\t\t\tif (zapi.$footer.prev()[0].className !== 'spinner') {\n\t\t\t\t// First, our styles\n\t\t\t\t$('head').append('<style>' + zapi.loading_indicator_styles + '</style>');\n\t\t\t\t// And our markup\n\t\t\t\tzapi.$footer.before(zapi.loading_indicator_html);\n\t\t\t}\n\t\t\t\n\t\t\t// Add loading references class\n\t\t\tzapi.$parent_body.addClass(zapi.loading_class);\n\t\t\t$.ajax({\n\t\t\t\turl: feed_url,\n\t\t\t\tdataType: 'jsonp',\n\t\t\t\tsuccess: function(resp) {\n\t\t\t\t\tvar // Structure of resp: resp.responseData.feed.entries[]\n\t\t\t\t\t\t$feed       = $($.parseXML(resp.responseData.xmlString)),\n\t\t\t\t\t\t$entries    = $feed.find('entry'),\n\t\t\t\t\t\tlen         = $entries.length,\n\t\t\t\t\t\ti           = 0,\n\t\t\t\t\t\tref_html    = '',\n\t\t\t\t\t\tthe_year    = '',\n\t\t\t\t\t\tyear_class  = '',\n\t\t\t\t\t\tis_new_year = false,\n\t\t\t\t\t\tthe_month,\n\t\t\t\t\t\t$entry,\n\t\t\t\t\t\t$bib,\n\t\t\t\t\t\tbib_html,\n\t\t\t\t\t\tbib_url_start,\n\t\t\t\t\t\tentry,\n\t\t\t\t\t\tentry_class;\n\n\t\t\t\t\t// Check if we have set the total results yet\n\t\t\t\t\tif (zapi.total === false) {\n\t\t\t\t\t\t// First time through, try to fetch totalResults node using the namespace ('zapi\\\\:')\n\t\t\t\t\t\tzapi.total = $feed.find(zapi.namespace + 'totalResults');\n\t\t\t\t\t\t// If that failed, try it without the namespace (set the namespace as an empty string)\n\t\t\t\t\t\tif (!zapi.total.length) {\n\t\t\t\t\t\t\tzapi.namespace = '';\n\t\t\t\t\t\t\tzapi.total = $feed.find(zapi.namespace + 'totalResults');\n\t\t\t\t\t\t}\n\t\t\t\t\t\tzapi.total = parseInt(zapi.total.text(), 10);\n\t\t\t\t\t}\n\t\t\t\t\tfor (; i < len; i++) {\n\t\t\t\t\t\t$entry = $($entries[i]);\n\t\t\t\t\t\t// If this selector doesn't work, we need to use a filter function and check attr('zapi:type')\n\t\t\t\t\t\tentry = $.parseJSON($entry.find(zapi.namespace + 'subcontent').filter(zapi.filterByType('json')).text());\n\t\t\t\t\t\t\n\t\t\t\t\t\tentry_class = 'ref-entry';\n\t\t\t\t\t\t\n\t\t\t\t\t\tthe_year = $entry.find(zapi.namespace + 'year').text();\n\t\t\t\t\t\tis_new_year = zapi.years[zapi.years.length - 1] !== the_year;\n\t\t\t\t\t\t// Is it a new year section or the first of this group of references\n\t\t\t\t\t\tif (!ref_html.length || is_new_year) {\n\t\t\t\t\t\t\t// If this is not the first year header and not the first of this group of references, close the previous year div\n\t\t\t\t\t\t\tif (zapi.years.length && ref_html.length) {\n\t\t\t\t\t\t\t\tref_html += '</div>';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tyear_class = zapi.year_section_class + ' ' + the_year;\n\t\t\t\t\t\t\t// If this is the very first year, add .first class\n\t\t\t\t\t\t\tif (!zapi.years.length) {\n\t\t\t\t\t\t\t\tyear_class += ' first';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tref_html += '<div class=\"' + year_class + '\">';\n\t\t\t\t\t\t\t// If first of this year, add heading and push year onto years array\n\t\t\t\t\t\t\tif (is_new_year) {\n\t\t\t\t\t\t\t\tref_html += '<h2 id=\"year-' + the_year + '\">' + the_year + '</h2>';\n\t\t\t\t\t\t\t\tzapi.years.push(the_year);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Quarterly logic requires the date also\n\t\t\t\t\t\tif (zapi.params.quarterly) {\n\t\t\t\t\t\t\tthe_month = new Date(entry.date);\n\t\t\t\t\t\t\tthe_month = the_month.getMonth();\n\t\t\t\t\t\t\tif (isNaN(the_month)) {\n\t\t\t\t\t\t\t\t// Default to the first month\n\t\t\t\t\t\t\t\tthe_month = 0;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tentry_class += ' year-' + the_year + ' quarter-' + Math.floor(the_month / 3);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Entry wrap\n\t\t\t\t\t\tref_html += '<div class=\"' + entry_class + '\">';\n\t\t\t\t\t\t// Title\n\t\t\t\t\t\tref_html += '<h6>' + (entry.url ? '<a href=\"' + entry.url + '\" target=\"_blank\">' : '') + entry.title + (entry.url ? '</a>' : '') + '</h6>';\n\n\t\t\t\t\t\t$bib = $entry.find(zapi.namespace + 'subcontent').filter(zapi.filterByType('bib')).children('div');\n\t\t\t\t\t\tif ($bib.length) {\n\t\t\t\t\t\t\tbib_html = $bib[0].outerHTML;\n\t\t\t\t\t\t\tif (entry.url) {\n\t\t\t\t\t\t\t\tbib_url_start = bib_html.lastIndexOf(' from http://');\n\t\t\t\t\t\t\t\tif (bib_url_start === -1) {\n\t\t\t\t\t\t\t\t\tbib_url_start = bib_html.lastIndexOf(' from https://');\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif (bib_url_start !== -1) {\n\t\t\t\t\t\t\t\t\t// The \"from [url]\" text always has ' Retrieved' before it, so go find that text\n\t\t\t\t\t\t\t\t\t// bib_url_start -= 10;\n\t\t\t\t\t\t\t\t\tbib_url_start = bib_html.substring(0, bib_url_start).lastIndexOf(' Retrieved');\n\t\t\t\t\t\t\t\t\tif (bib_url_start !== -1) {\n\t\t\t\t\t\t\t\t\t\tbib_html = bib_html.substring(0, bib_url_start) + bib_html.substring(bib_html.indexOf('</div>'));\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tref_html += bib_html;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tref_html += '</div>';\n\t\t\t\t\t}\n\t\t\t\t\t// Close div.year-section\n\t\t\t\t\tref_html += '</div>';\n\t\t\t\t\t// First time through, add in year filter html\n\t\t\t\t\tif (zapi.is_init) {\n\t\t\t\t\t\tref_html = zapi.year_filter_html + ref_html;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Finished building HTML\n\t\t\t\t\t// Pass it to callback\n\t\t\t\t\t// ----------------------\n\t\t\t\t\tzapi.callback(ref_html);\n\t\t\t\t\t// ----------------------\n\n\t\t\t\t\t// Initial run through, set up JS and styles for year filter\n\t\t\t\t\tif (zapi.is_init) {\n\t\t\t\t\t\t// Set this flag now to false to avoid conflicts with calling getReferences again\n\t\t\t\t\t\tzapi.is_init = false;\n\t\t\t\t\t\t// Attach filter by year click handler\n\t\t\t\t\t\tzapi.$year_filter = zapi.$body.find('.year-filter');\n\t\t\t\t\t\tzapi.$body.on('click.year-filter.' + zapi.collection_name, '.year-filter', zapi.loadYearFilterList);\n\t\t\t\t\t\tzapi.$body.on('references-load.' + zapi.collection_name, function() {\n\t\t\t\t\t\t\tvar // Prepare for year calculations\n\t\t\t\t\t\t\t\tyear_list = '',\n\t\t\t\t\t\t\t\ti         = 0,\n\t\t\t\t\t\t\t\tlen       = zapi.years.length;\n\n\t\t\t\t\t\t\t// Reset $year_filter object from DOM\n\t\t\t\t\t\t\tzapi.$year_filter = zapi.$body.find('.year-filter');\n\t\t\t\t\t\t\t// Remove all click handlers, then add back simple toggle handler\n\t\t\t\t\t\t\tzapi.$body.off('click.year-filter.' + zapi.collection_name).on('click.year-filter.' + zapi.collection_name, '.year-filter', zapi.yearFilterToggle);\n\t\t\t\t\t\t\tzapi.$body.off('click.year-filter.' + zapi.collection_name).on('click.year-filter.' + zapi.collection_name, '.year-filter h3', zapi.yearFilterTitleToggle);\n\t\t\t\t\t\t\t// Set up year section element cache\n\t\t\t\t\t\t\tzapi.$year_sections = zapi.$body.find('.' + zapi.year_section_class);\n\t\t\t\t\t\t\t// Build years list\n\t\t\t\t\t\t\tfor (; i < len; i++) {\n\t\t\t\t\t\t\t\tif (zapi.years[i].length) {\n\t\t\t\t\t\t\t\t\tyear_list += '<h6><a class=\"year-link\" href=\"#year-' + zapi.years[i] + '\">' + zapi.years[i] + '</a></h6>';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tzapi.$year_filter.find('.group').append(year_list);\n\t\t\t\t\t\t\tzapi.$year_links = zapi.$year_filter.find('a.year-link');\n\t\t\t\t\t\t\tzapi.$year_links.on('click.' + zapi.collection_name, function(evt) {\n\t\t\t\t\t\t\t\tevt.preventDefault();\n\t\t\t\t\t\t\t\tvar $year_link  = $(this),\n\t\t\t\t\t\t\t\t\tactive_year = '';\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t// No other year links should be active\n\t\t\t\t\t\t\t\tzapi.$year_links.not($year_link).removeClass('active');\n\t\t\t\t\t\t\t\t$year_link.toggleClass('active');\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\tif ($year_link.hasClass('active')) {\n\t\t\t\t\t\t\t\t\tactive_year = '.' + this.innerHTML;\n\t\t\t\t\t\t\t\t\t/*zapi.$year_links.filter('.active').each(function() {\n\t\t\t\t\t\t\t\t\t\tactive_year += (active_year.length ? ', ' : '') + '.' + this.innerHTML;\n\t\t\t\t\t\t\t\t\t});*/\n\n\t\t\t\t\t\t\t\t\t// Add filtered class\n\t\t\t\t\t\t\t\t\tzapi.$body.addClass('filtered');\n\t\t\t\t\t\t\t\t\tzapi.$year_sections.not(active_year).removeClass('active').fadeOut();\n\t\t\t\t\t\t\t\t\tzapi.$year_sections.filter(active_year).addClass('active').fadeIn();\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tzapi.$body.removeClass('filtered');\n\t\t\t\t\t\t\t\t\tzapi.$year_sections.fadeIn();\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t// Recalculate iframe height after 0.3 seconds\n\t\t\t\t\t\t\t\twindow.setTimeout(function() {\n\t\t\t\t\t\t\t\t\tzapi.$window.trigger('resize.tabs.' + zapi.collection_name);\n\t\t\t\t\t\t\t\t}, 300);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t// Remove this handler\n\t\t\t\t\t\t\tzapi.$body.off('references-load.' + zapi.collection_name);\n\t\t\t\t\t\t\t// After letting year links settle, remove loading class (to enable smooth dropdown effect)\n\t\t\t\t\t\t\twindow.setTimeout(function() {\n\t\t\t\t\t\t\t\tzapi.$body.removeClass(zapi.loading_class);\n\t\t\t\t\t\t\t}, 50);\n\t\t\t\t\t\t\t// If .year-filter is currently active, recalculate iframe height after 0.5 seconds\n\t\t\t\t\t\t\tif (zapi.$year_filter.hasClass('active')) {\n\t\t\t\t\t\t\t\twindow.setTimeout(function() {\n\t\t\t\t\t\t\t\t\tzapi.$window.trigger('resize.tabs.' + zapi.collection_name);\n\t\t\t\t\t\t\t\t}, 500);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// Now set up quarter filters, if applicable\n\t\t\t\t\t\t\tif (zapi.params.quarterly) {\n\t\t\t\t\t\t\t\tzapi.$body.find('h2').each(function() {\n\t\t\t\t\t\t\t\t\tvar $year_title = $(this),\n\t\t\t\t\t\t\t\t\t\tthe_year = this.innerHTML,\n\t\t\t\t\t\t\t\t\t\tquarters,\n\t\t\t\t\t\t\t\t\t\t$quarters,\n\t\t\t\t\t\t\t\t\t\trefs_by_quarter = [];\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tif (!the_year.length) {\n\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tquarters = '<div class=\"quarters\">';\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tfor (var i = 0; i < 4; i++) {\n\t\t\t\t\t\t\t\t\t\trefs_by_quarter[i] = zapi.$body.find('.' + zapi.year_section_class + '.' + the_year + ' .quarter-' + i);\n\t\t\t\t\t\t\t\t\t\tif (refs_by_quarter[i].length) {\n\t\t\t\t\t\t\t\t\t\t\tquarters += '<span class=\"quarter-filter\" data-quarter=\"' + i + '\">' + zapi.quarter_labels[i] + '</span>';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tquarters += '</div>';\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t$year_title.addClass('quarterly');\n\t\t\t\t\t\t\t\t\t$quarters = $(quarters).insertAfter($year_title);\n\t\t\t\t\t\t\t\t\t$quarters.on('click', '.quarter-filter', function() {\n\t\t\t\t\t\t\t\t\t\tvar $filter = $(this),\n\t\t\t\t\t\t\t\t\t\t\tactive_quarter = '',\n\t\t\t\t\t\t\t\t\t\t\ti;\n\t\t\t\t\t\t\t\t\t\t// No other quarter links should be active\n\t\t\t\t\t\t\t\t\t\t$quarters.find('.quarter-filter').not($filter).removeClass('active');\n\t\t\t\t\t\t\t\t\t\t$filter.toggleClass('active');\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\tif ($filter.hasClass('active')) {\n\t\t\t\t\t\t\t\t\t\t\tactive_quarter = parseInt($filter.data('quarter'), 10);\n\t\t\t\t\t\t\t\t\t\t\tfor (i = 0; i < 4; i++) {\n\t\t\t\t\t\t\t\t\t\t\t\tif (i !== active_quarter) {\n\t\t\t\t\t\t\t\t\t\t\t\t\trefs_by_quarter[i].fadeOut();\n\t\t\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\t\t\trefs_by_quarter[i].fadeIn();\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\tfor (i = 0; i < 4; i++) {\n\t\t\t\t\t\t\t\t\t\t\t\tif (i !== active_quarter) {\n\t\t\t\t\t\t\t\t\t\t\t\t\trefs_by_quarter[i].fadeIn();\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tzapi.is_init = false;\n\t\t\t\t\tzapi.$parent_body.removeClass(zapi.loading_class);\n\t\t\t\t\t// When this tab is selected, a resize is triggered; use that opportunity to fix the iframe height\n\t\t\t\t\t// And then trigger the logic once right away for the default tab\n\t\t\t\t\tzapi.$window.on('resize.tabs.' + zapi.collection_name, zapi.fixTabHeight).trigger('resize.tabs.' + zapi.collection_name);\n\t\t\t\t\t\n\t\t\t\t\t// If we have not yet loaded all the references, set up fetching of the next set of references\n\t\t\t\t\tif (zapi.params.start + zapi.params.num_entries < zapi.total) {\n\t\t\t\t\t\tzapi.getNextReferences();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tzapi.all_loaded = true;\n\t\t\t\t\t\tzapi.$body.trigger('references-load.' + zapi.collection_name);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\t// Set up infinite scroll-style fetching of next set of references (or trigger it right away if load_all)\n\t\tgetNextReferences: function(timedout) {\n\t\t\t// If not load_all and this is not the timeout, set up timeout and return\n\t\t\tif (!zapi.load_all && !timedout) {\n\t\t\t\t// Make sure resize.tabs has had a chance to do its magic by attaching inview event after 500 ms\n\t\t\t\twindow.setTimeout(function() {\n\t\t\t\t\tzapi.getNextReferences(true);\n\t\t\t\t}, 500);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tzapi.params.start += zapi.params.num_entries;\n\t\t\t\n\t\t\t// If this is the first time calling getNextReferences, adjust num_entries to 50\n\t\t\tif (zapi.params.start === zapi.params.num_entries) {\n\t\t\t\tzapi.params.num_entries = 50;\n\t\t\t}\n\t\t\t\n\t\t\t// If not load_all, add a handler to the parent window to load the next set of results\n\t\t\tif (!zapi.load_all) {\n\t\t\t\tzapi.$footer.on('inview.' + zapi.collection_name, function() {\n\t\t\t\t\t// Is the current active tab this one?\n\t\t\t\t\tif ($('.tab-pane.active').attr('id') !== zapi.collection_name) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\t// It is the current tab, so remove this handler and get the next set of references\n\t\t\t\t\tzapi.$footer.off('inview.' + zapi.collection_name);\n\t\t\t\t\tzapi.getReferences();\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tzapi.getReferences();\n\t\t\t}\n\t\t},\n\t\tprepareMarkup: function() {\n\t\t\t// HTML and CSS snippets\n\t\t\tzapi.loading_indicator_styles = '.spinner { display: none; position: absolute; left: 45%; width: 50px; height: 30px; text-align: center; font-size: 10px; } body.' + zapi.loading_class + ' .spinner { display: block; } .spinner > div { background-color: #333; height: 100%; width: 6px; margin: 0 1px; display: inline-block;  -webkit-animation: stretchdelay 1.2s infinite ease-in-out; animation: stretchdelay 1.2s infinite ease-in-out; } .spinner .rect2 { -webkit-animation-delay: -1.1s; animation-delay: -1.1s; } .spinner .rect3 { -webkit-animation-delay: -1.0s; animation-delay: -1.0s; } .spinner .rect4 { -webkit-animation-delay: -0.9s; animation-delay: -0.9s; } .spinner .rect5 { -webkit-animation-delay: -0.8s; animation-delay: -0.8s; } @-webkit-keyframes stretchdelay { 0%, 40%, 100% { -webkit-transform: scaleY(0.4) } 20% { -webkit-transform: scaleY(1.0) } } @keyframes stretchdelay { 0%, 40%, 100% { transform: scaleY(0.4); -webkit-transform: scaleY(0.4); } 20% {  transform: scaleY(1.0); -webkit-transform: scaleY(1.0); } }';\n\t\t\tzapi.loading_indicator_html   = '<div class=\"spinner\"><div class=\"rect1\"></div><div class=\"rect2\"></div><div class=\"rect3\"></div><div class=\"rect4\"></div><div class=\"rect5\"></div></div>';\n\t\t\tzapi.year_heading_styles      = '#boot .' + zapi.year_section_class + ' h2 { margin-top: 20px; } #boot .' + zapi.year_section_class + '.first h2 { margin-top: 0; } #boot .' + zapi.year_section_class + ' h6 { margin-top: 1em; }';\n\t\t\tzapi.year_filter_html         = '<nav class=\"year-filter c-accordion\"><div class=\"item\"><span class=\"group\"><h3>Archive <div class=\"arrow\"></div></h3>' + zapi.loading_indicator_html + '</span></div></nav>';\n\t\t\tzapi.year_filter_styles       = '.year-filter{width:30%;min-width:160px;float:right;margin-bottom:.5em}.year-filter .item{position:relative;max-height:50px;overflow:hidden;cursor:pointer}.year-filter.active .item{max-height:450px;overflow-y:auto;cursor:default}body.loading-references .year-filter.active .item{max-height:110px;overflow:hidden}.year-filter .spinner{position:static;margin:1em auto}.year-filter h3{cursor:pointer}.year-filter h6 a{display:block;padding:.2em 1em}.quarter-filter:hover,.year-filter h6 a:hover{background:#f0f0f0;cursor:pointer}.quarter-filter.active,.quarter-filter.active:hover,.year-filter h6 a.active,.year-filter h6 a.active:hover{background:#ddd}.quarters{float:left;margin-left:9px;margin-top:20px;line-height:42px}.year-section.first .quarters{margin-top:0}.quarter-filter{border:1px solid #e5e5e5;font-weight:700;font-size:13px;padding:.25em .35em;margin:0 .25em}h2.quarterly{float:left}.ref-entry{clear:left}#boot .year-filter h6 a:hover{text-decoration:none}#boot .year-filter.active .item:hover{background-color:transparent}';\n\t\t},\n\t\tloadYearFilterList: function(evt) {\n\t\t\tevt.stopPropagation();\n\t\t\t// Add .active/.open\n\t\t\tzapi.yearFilterAddActive();\n\t\t\t\n\t\t\tif (!zapi.all_loaded) {\n\t\t\t\tif (zapi.load_all) {\n\t\t\t\t\t// Already working on it\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t// Load 'em up\n\t\t\t\tzapi.load_all = true;\n\t\t\t\t// Load max number of entries at a time\n\t\t\t\tzapi.params.num_entries = 99;\n\t\t\t\t// Set loading class\n\t\t\t\tzapi.$body.addClass(zapi.loading_class);\n\t\t\t\t// Kick off reference retrieval\n\t\t\t\tzapi.getReferences();\n\t\t\t}\n\t\t\t// Don't run this function again\n\t\t\tzapi.$body.off('click.year-filter.' + zapi.collection_name);\n\t\t\tzapi.$body.on('click.year-filter.' + zapi.collection_name, '.year-filter', zapi.yearFilterToggle);\n\t\t\tzapi.$body.on('click.year-filter.' + zapi.collection_name, '.year-filter h3', zapi.yearFilterTitleToggle);\n\t\t},\n\t\tyearFilterToggle: function(evt) {\n\t\t\tevt.stopPropagation();\n\t\t\t// Add .active/.open\n\t\t\tzapi.yearFilterAddActive();\n\n\t\t\t// Recalculate iframe height after 0.5 seconds\n\t\t\twindow.setTimeout(function() {\n\t\t\t\tzapi.$window.trigger('resize.tabs.' + zapi.collection_name);\n\t\t\t}, 500);\n\t\t},\n\t\tyearFilterTitleToggle: function(evt) {\n\t\t\tevt.stopPropagation();\n\t\t\t// Toggle .active/.open\n\t\t\tzapi.yearFilterToggleActive();\n\t\t\t\n\t\t\t// Recalculate iframe height after 0.5 seconds\n\t\t\twindow.setTimeout(function() {\n\t\t\t\tzapi.$window.trigger('resize.tabs.' + zapi.collection_name);\n\t\t\t}, 500);\n\t\t},\n\t\tyearFilterAddActive: function($year_filter) {\n\t\t\t$year_filter = $year_filter || zapi.$body.find('.year-filter');\n\t\t\tif (!$year_filter.hasClass('active')) {\n\t\t\t\t$year_filter.addClass('active');\n\t\t\t\t$year_filter.find('.item').addClass('open');\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn false;\n\t\t},\n\t\tyearFilterToggleActive: function($year_filter) {\n\t\t\t$year_filter = $year_filter || zapi.$body.find('.year-filter');\n\t\t\tif (!zapi.yearFilterAddActive($year_filter)) {\n\t\t\t\t$year_filter.removeClass('active');\n\t\t\t\t$year_filter.find('.item').removeClass('open');\n\t\t\t}\n\t\t}\n\t};\n\n\t// Suggested approach\n\t// 1. Parse responseData.xmlString of response into a document tree and wrap it with jQuery\n\t// var $resp = $($.parseXML(resp.responseData.xmlString));\n\t// 2. Loop through the entries using .each(); if necessary, fall back to the JSON using resp.responseData.feed.entries[idx] (shouldn't be necessary)\n\t// $resp.find('entry').each(function(idx) {});\n\n\t// Export our Zotero API handler\n\twindow.zotero_api = zapi;\n\t\n\t// Attach jquery.inview to parent if not yet attached\n\tif ($.event.special.inview === undefined) {\n\t\tjs_plugin_src = window.location.href.split('/');\n\t\tjs_plugin_src.pop();\n\t\tjs_plugin_src.push('jquery.inview.min.js');\n\t\tzapi.$parent_body.append('<script src=\"' + js_plugin_src.join('/') + '\"><\\/script>');\n\t}\n})(window.jQuery || window.parent.jQuery);\n"]}