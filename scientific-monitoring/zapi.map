{"version":3,"file":"zapi.js","sources":["zapi-compiled.js"],"names":["$","zapi","js_plugin_src","defaults","collection","user","num_entries","start","zotero_options","params","callback","collection_name","window","location","pathname","split","pop","replace","feed_base","namespace","$body","document","body","$window","$parent_body","$footer","$year_filter","$year_links","$year_sections","years","total","is_init","load_all","all_loaded","loading_class","year_section_class","loading_indicator_styles","loading_indicator_html","year_heading_styles","year_filter_html","year_filter_styles","tab_height_timeout","fixTabHeight","clearTimeout","setTimeout","off","frameElement","height","tab_height","parent","on","filterByType","type","this","attr","buildParams","options","extend","getFeedUrl","feed_url","Date","toDateString","q","encodeURIComponent","getReferences","prepareMarkup","hasClass","find","append","addClass","prev","className","before","ajax","url","dataType","success","resp","$entry","$bib","bib_html","bib_url_start","entry","$feed","parseXML","responseData","xmlString","$entries","len","length","i","ref_html","the_year","year_class","is_new_year","parseInt","text","parseJSON","filter","push","title","children","outerHTML","lastIndexOf","substring","indexOf","loadYearFilterList","year_list","yearFilterToggle","yearFilterTitleToggle","evt","preventDefault","$year_link","active_years","toggleClass","each","innerHTML","not","removeClass","fadeOut","fadeIn","trigger","getNextReferences","timedout","stopPropagation","yearFilterAddActive","yearFilterToggleActive","zotero_api","undefined","event","special","inview","href","join","jQuery"],"mappings":"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","sourcesContent":["(function($) {\n\tvar zapi, js_plugin_src;\n\n\tzapi = {\n\t\tdefaults : {\n\t\t\tcollection     : '',\n\t\t\tuser           : '1562960',\n\t\t\t// Number of entries to fetch\n\t\t\tnum_entries    : 20,\n\t\t\tstart          : 0,\n\t\t\tzotero_options : 'format=atom&content=json,bib&style=apa&order=date&sort=desc'\n\t\t},\n\t\tparams          : {},\n\t\tcallback        : {},\n\t\tcollection_name : window.location.pathname.split('/').pop().replace('archive-', '').replace('monitoring-', '').replace('.html', ''),\n\t\tfeed_base       : 'https://api.zotero.org/users/',\n\t\tnamespace       : 'zapi\\\\:',\n\t\t// @todo try fetching xml nodes with namespace prefix; if it doesn't work, set namespace prefix to ''\n\t\t// Element cache (careful with using string selectors with this jQuery; it will search the parent DOM)\n\t\t$body          : $(document.body),\n\t\t$window        : $(window),\n\t\t$parent_body   : $('body'),\n\t\t$footer        : $('.c-back-to-top'),\n\t\t$year_filter   : $(),\n\t\t$year_links    : $(),\n\t\t$year_sections : $(),\n\t\t// An array of years of the references (for archive page)\n\t\tyears      : [],\n\t\t// Total number of references\n\t\ttotal      : false,\n\t\t// Flag if is initial load\n\t\tis_init    : true,\n\t\t// Flag for loading all references immediately\n\t\tload_all   : false,\n\t\t// Flag for keeping track if all references have been loaded\n\t\tall_loaded : false,\n\t\t// Class to add to body when loading references\n\t\tloading_class      : 'loading-references',\n\t\t// Class to add to year sections\n\t\tyear_section_class : 'year-section',\n\t\t// HTML and CSS snippets\n\t\tloading_indicator_styles : '',\n\t\tloading_indicator_html   : '',\n\t\tyear_heading_styles      : '',\n\t\tyear_filter_html         : '',\n\t\tyear_filter_styles       : '',\n\t\t// Set the correct height of the tab iframe\n\t\ttab_height_timeout: '',\n\t\tfixTabHeight: function() {\n\t\t\twindow.clearTimeout(zapi.tab_height_timeout);\n\t\t\tzapi.tab_height_timeout = window.setTimeout(function() {\n\t\t\t\t// Remove this event listener, adjust height, add back the listener\n\t\t\t\tzapi.$window.off('resize.tabs.' + zapi.collection_name);\n\t\t\t\t// Set height with extra 50px\n\t\t\t\twindow.frameElement.height = zapi.tab_height = zapi.$body.parent().height() + 50;\n\t\t\t\t// Add back the listener\n\t\t\t\twindow.setTimeout(function() {\n\t\t\t\t\tzapi.$window.on('resize.tabs.' + zapi.collection_name, zapi.fixTabHeight);\n\t\t\t\t}, 200);\n\t\t\t}, 200);\n\t\t},\n\t\tfilterByType: function(type) {\n\t\t\treturn function() {\n\t\t\t\treturn $(this).attr('zapi:type') === type;\n\t\t\t};\n\t\t},\n\t\tbuildParams: function(options) {\n\t\t\tzapi.params = $.extend({}, zapi.defaults, options);\n\t\t},\n\t\tgetFeedUrl: function() {\n\t\t\tvar feed_url = zapi.feed_base;\n\t\t\t\n\t\t\t// Build the zotero api url\n\t\t\tfeed_url += zapi.params.user + '/collections/' + zapi.params.collection + '/items?' + zapi.params.zotero_options + '&start=' + zapi.params.start + '&limit=' + zapi.params.num_entries;\n\t\t\t\n\t\t\t// Add a 24 hour cache busting date string\n\t\t\tfeed_url += '&cb=' + new Date().toDateString();\n\t\t\t\n\t\t\tif (zapi.params.q) {\n\t\t\t\tfeed_url += '&q=' + zapi.params.q + '&qmode=titleCreatorYear';\n\t\t\t}\n\t\t\t// Build the google feed api url and return it\n\t\t\treturn 'https://ajax.googleapis.com/ajax/services/feed/load?v=1.0&output=xml&num=' + zapi.params.num_entries + '&q=' + encodeURIComponent(feed_url);\n\t\t},\n\t\tgetReferences: function(options, callback) {\n\t\t\t// If we have options (like on first load), use them\n\t\t\tif (options) {\n\t\t\t\t// Build our params, then get the feed url\n\t\t\t\tzapi.buildParams(options);\n\t\t\t\tif (callback) {\n\t\t\t\t\tzapi.callback = callback;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (zapi.is_init) {\n\t\t\t\tzapi.prepareMarkup();\n\t\t\t}\n\t\t\t// If all references are already loaded, return\n\t\t\tif (zapi.all_loaded) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// Get the google feed api url\n\t\t\tvar feed_url = zapi.getFeedUrl();\n\t\t\t\n\t\t\t// Check if the iframe has our styles yet\n\t\t\tif (!zapi.$body.hasClass('ready')) {\n\t\t\t\t$(document).find('head').append('<style>' + zapi.year_heading_styles + '\\n' + zapi.loading_indicator_styles + '\\n' + zapi.year_filter_styles + '</style>');\n\t\t\t\tzapi.$body.addClass('ready');\n\t\t\t}\n\n\t\t\t// If the spinner markup is not yet in the parent.window DOM, set it up and add styles\n\t\t\tif (zapi.$footer.prev()[0].className !== 'spinner') {\n\t\t\t\t// First, our styles\n\t\t\t\t$('head').append('<style>' + zapi.loading_indicator_styles + '</style>');\n\t\t\t\t// And our markup\n\t\t\t\tzapi.$footer.before(zapi.loading_indicator_html);\n\t\t\t}\n\t\t\t\n\t\t\t// Add loading references class\n\t\t\tzapi.$parent_body.addClass(zapi.loading_class);\n\t\t\t$.ajax({\n\t\t\t\turl: feed_url,\n\t\t\t\tdataType: 'jsonp',\n\t\t\t\tsuccess: function(resp) {\n\t\t\t\t\tvar // Structure of resp: resp.responseData.feed.entries[]\n\t\t\t\t\t\t$feed       = $($.parseXML(resp.responseData.xmlString)),\n\t\t\t\t\t\t$entries    = $feed.find('entry'),\n\t\t\t\t\t\tlen         = $entries.length,\n\t\t\t\t\t\ti           = 0,\n\t\t\t\t\t\tref_html    = '',\n\t\t\t\t\t\tthe_year    = '',\n\t\t\t\t\t\tyear_class  = '',\n\t\t\t\t\t\tis_new_year = false,\n\t\t\t\t\t\t$entry,\n\t\t\t\t\t\t$bib,\n\t\t\t\t\t\tbib_html,\n\t\t\t\t\t\tbib_url_start,\n\t\t\t\t\t\tentry;\n\n\t\t\t\t\t// Check if we have set the total results yet\n\t\t\t\t\tif (zapi.total === false) {\n\t\t\t\t\t\t// First time through, try to fetch totalResults node using the namespace ('zapi\\\\:')\n\t\t\t\t\t\tzapi.total = $feed.find(zapi.namespace + 'totalResults');\n\t\t\t\t\t\t// If that failed, try it without the namespace (set the namespace as an empty string)\n\t\t\t\t\t\tif (!zapi.total.length) {\n\t\t\t\t\t\t\tzapi.namespace = '';\n\t\t\t\t\t\t\tzapi.total = $feed.find(zapi.namespace + 'totalResults');\n\t\t\t\t\t\t}\n\t\t\t\t\t\tzapi.total = parseInt(zapi.total.text(), 10);\n\t\t\t\t\t}\n\t\t\t\t\tfor (; i < len; i++) {\n\t\t\t\t\t\t$entry = $($entries[i]);\n\t\t\t\t\t\t// If this selector doesn't work, we need to use a filter function and check attr('zapi:type')\n\t\t\t\t\t\tentry = $.parseJSON($entry.find(zapi.namespace + 'subcontent').filter(zapi.filterByType('json')).text());\n\t\t\t\t\t\t\n\t\t\t\t\t\tthe_year = $entry.find(zapi.namespace + 'year').text();\n\t\t\t\t\t\tis_new_year = zapi.years[zapi.years.length - 1] !== the_year;\n\t\t\t\t\t\t// Is it a new year section or the first of this group of references\n\t\t\t\t\t\tif (!ref_html.length || is_new_year) {\n\t\t\t\t\t\t\t// If this is not the first year header and not the first of this group of references, close the previous year div\n\t\t\t\t\t\t\tif (zapi.years.length && ref_html.length) {\n\t\t\t\t\t\t\t\tref_html += '</div>';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tyear_class = zapi.year_section_class + ' ' + the_year;\n\t\t\t\t\t\t\t// If this is the very first year, add .first class\n\t\t\t\t\t\t\tif (!zapi.years.length) {\n\t\t\t\t\t\t\t\tyear_class += ' first';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tref_html += '<div class=\"' + year_class + '\">';\n\t\t\t\t\t\t\t// If first of this year, add heading and push year onto years array\n\t\t\t\t\t\t\tif (is_new_year) {\n\t\t\t\t\t\t\t\tref_html += '<h2 id=\"year-' + the_year + '\">' + the_year + '</h2>';\n\t\t\t\t\t\t\t\tzapi.years.push(the_year);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Title\n\t\t\t\t\t\tref_html += '<h6>' + (entry.url ? '<a href=\"' + entry.url + '\" target=\"_blank\">' : '') + entry.title + (entry.url ? '</a>' : '') + '</h6>';\n\n\t\t\t\t\t\t$bib = $entry.find(zapi.namespace + 'subcontent').filter(zapi.filterByType('bib')).children('div');\n\t\t\t\t\t\tif ($bib.length) {\n\t\t\t\t\t\t\tbib_html = $bib[0].outerHTML;\n\t\t\t\t\t\t\tif (entry.url) {\n\t\t\t\t\t\t\t\tbib_url_start = bib_html.lastIndexOf(' from http://');\n\t\t\t\t\t\t\t\tif (bib_url_start === -1) {\n\t\t\t\t\t\t\t\t\tbib_url_start = bib_html.lastIndexOf(' from https://');\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif (bib_url_start > 0) {\n\t\t\t\t\t\t\t\t\tbib_url_start = bib_html.lastIndexOf('. Retrieved ');\n\t\t\t\t\t\t\t\t\tbib_html = bib_html.substring(0, bib_url_start + 1) + bib_html.substring(bib_html.indexOf('</div>'));\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tref_html += bib_html;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t// Close div.year-section\n\t\t\t\t\tref_html += '</div>';\n\t\t\t\t\t// First time through, add in year filter html\n\t\t\t\t\tif (zapi.is_init) {\n\t\t\t\t\t\tref_html = zapi.year_filter_html + ref_html;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Finished building HTML\n\t\t\t\t\t// Pass it to callback\n\t\t\t\t\t// ----------------------\n\t\t\t\t\tzapi.callback(ref_html);\n\t\t\t\t\t// ----------------------\n\n\t\t\t\t\t// Initial run through, set up JS and styles for year filter\n\t\t\t\t\tif (zapi.is_init) {\n\t\t\t\t\t\t// Set this flag now to false to avoid conflicts with calling getReferences again\n\t\t\t\t\t\tzapi.is_init = false;\n\t\t\t\t\t\t// Attach filter by year click handler\n\t\t\t\t\t\tzapi.$year_filter = zapi.$body.find('.year-filter');\n\t\t\t\t\t\tzapi.$body.on('click.year-filter.' + zapi.collection_name, '.year-filter', zapi.loadYearFilterList);\n\t\t\t\t\t\tzapi.$body.on('references-load.' + zapi.collection_name, function() {\n\t\t\t\t\t\t\tvar // Prepare for year calculations\n\t\t\t\t\t\t\t\tyear_list = '',\n\t\t\t\t\t\t\t\ti         = 0,\n\t\t\t\t\t\t\t\tlen       = zapi.years.length;\n\n\t\t\t\t\t\t\t// Reset $year_filter object from DOM\n\t\t\t\t\t\t\tzapi.$year_filter = zapi.$body.find('.year-filter');\n\t\t\t\t\t\t\t// Remove all click handlers, then add back simple toggle handler\n\t\t\t\t\t\t\tzapi.$body.off('click.year-filter.' + zapi.collection_name).on('click.year-filter.' + zapi.collection_name, '.year-filter', zapi.yearFilterToggle);\n\t\t\t\t\t\t\tzapi.$body.off('click.year-filter.' + zapi.collection_name).on('click.year-filter.' + zapi.collection_name, '.year-filter h3', zapi.yearFilterTitleToggle);\n\t\t\t\t\t\t\t// Set up year section element cache\n\t\t\t\t\t\t\tzapi.$year_sections = zapi.$body.find('.' + zapi.year_section_class);\n\t\t\t\t\t\t\t// Build years list\n\t\t\t\t\t\t\tfor (; i < len; i++) {\n\t\t\t\t\t\t\t\tif (zapi.years[i].length) {\n\t\t\t\t\t\t\t\t\tyear_list += '<h6><a class=\"year-link\" href=\"#year-' + zapi.years[i] + '\">' + zapi.years[i] + '</a></h6>';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tzapi.$year_filter.find('.group').append(year_list);\n\t\t\t\t\t\t\tzapi.$year_links = zapi.$year_filter.find('a.year-link');\n\t\t\t\t\t\t\tzapi.$year_links.on('click.' + zapi.collection_name, function(evt) {\n\t\t\t\t\t\t\t\tevt.preventDefault();\n\t\t\t\t\t\t\t\tvar $year_link   = $(this),\n\t\t\t\t\t\t\t\t\tactive_years = '';\n\n\t\t\t\t\t\t\t\t$year_link.toggleClass('active');\n\n\t\t\t\t\t\t\t\tzapi.$year_links.filter('.active').each(function() {\n\t\t\t\t\t\t\t\t\tactive_years += (active_years.length ? ', ' : '') + '.' + this.innerHTML;\n\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\t// Add filtered class\n\t\t\t\t\t\t\t\tzapi.$body.addClass('filtered');\n\t\t\t\t\t\t\t\tzapi.$year_sections.not(active_years).removeClass('active').fadeOut();\n\t\t\t\t\t\t\t\tzapi.$year_sections.filter(active_years).addClass('active').fadeIn();\n\t\t\t\t\t\t\t\t// Recalculate iframe height after 0.3 seconds\n\t\t\t\t\t\t\t\twindow.setTimeout(function() {\n\t\t\t\t\t\t\t\t\tzapi.$window.trigger('resize.tabs.' + zapi.collection_name);\n\t\t\t\t\t\t\t\t}, 300);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t// Remove this handler\n\t\t\t\t\t\t\tzapi.$body.off('references-load.' + zapi.collection_name);\n\t\t\t\t\t\t\t// After letting year links settle, remove loading class (to enable smooth dropdown effect)\n\t\t\t\t\t\t\twindow.setTimeout(function() {\n\t\t\t\t\t\t\t\tzapi.$body.removeClass(zapi.loading_class);\n\t\t\t\t\t\t\t}, 50);\n\t\t\t\t\t\t\t// If .year-filter is currently active, recalculate iframe height after 0.5 seconds\n\t\t\t\t\t\t\tif (zapi.$year_filter.hasClass('active')) {\n\t\t\t\t\t\t\t\twindow.setTimeout(function() {\n\t\t\t\t\t\t\t\t\tzapi.$window.trigger('resize.tabs.' + zapi.collection_name);\n\t\t\t\t\t\t\t\t}, 500);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tzapi.is_init = false;\n\t\t\t\t\tzapi.$parent_body.removeClass(zapi.loading_class);\n\t\t\t\t\t// When this tab is selected, a resize is triggered; use that opportunity to fix the iframe height\n\t\t\t\t\t// And then trigger the logic once right away for the default tab\n\t\t\t\t\tzapi.$window.on('resize.tabs.' + zapi.collection_name, zapi.fixTabHeight).trigger('resize.tabs.' + zapi.collection_name);\n\t\t\t\t\t\n\t\t\t\t\t// If we have not yet loaded all the references, set up fetching of the next set of references\n\t\t\t\t\tif (zapi.params.start + zapi.params.num_entries < zapi.total) {\n\t\t\t\t\t\tzapi.getNextReferences();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tzapi.all_loaded = true;\n\t\t\t\t\t\tzapi.$body.trigger('references-load.' + zapi.collection_name);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\t// Set up infinite scroll-style fetching of next set of references (or trigger it right away if load_all)\n\t\tgetNextReferences: function(timedout) {\n\t\t\t// If not load_all and this is not the timeout, set up timeout and return\n\t\t\tif (!zapi.load_all && !timedout) {\n\t\t\t\t// Make sure resize.tabs has had a chance to do its magic by attaching inview event after 500 ms\n\t\t\t\twindow.setTimeout(function() {\n\t\t\t\t\tzapi.getNextReferences(true);\n\t\t\t\t}, 500);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tzapi.params.start += zapi.params.num_entries;\n\t\t\t\n\t\t\t// If this is the first time calling getNextReferences, adjust num_entries to 50\n\t\t\tif (zapi.params.start === zapi.params.num_entries) {\n\t\t\t\tzapi.params.num_entries = 50;\n\t\t\t}\n\t\t\t\n\t\t\t// If not load_all, add a handler to the parent window to load the next set of results\n\t\t\tif (!zapi.load_all) {\n\t\t\t\tzapi.$footer.on('inview.' + zapi.collection_name, function() {\n\t\t\t\t\t// Is the current active tab this one?\n\t\t\t\t\tif ($('.tab-pane.active').attr('id') !== zapi.collection_name) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\t// It is the current tab, so remove this handler and get the next set of references\n\t\t\t\t\tzapi.$footer.off('inview.' + zapi.collection_name);\n\t\t\t\t\tzapi.getReferences();\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tzapi.getReferences();\n\t\t\t}\n\t\t},\n\t\tprepareMarkup: function() {\n\t\t\t// HTML and CSS snippets\n\t\t\tzapi.loading_indicator_styles = '.spinner { display: none; position: absolute; left: 45%; width: 50px; height: 30px; text-align: center; font-size: 10px; } body.' + zapi.loading_class + ' .spinner { display: block; } .spinner > div { background-color: #333; height: 100%; width: 6px; margin: 0 1px; display: inline-block;  -webkit-animation: stretchdelay 1.2s infinite ease-in-out; animation: stretchdelay 1.2s infinite ease-in-out; } .spinner .rect2 { -webkit-animation-delay: -1.1s; animation-delay: -1.1s; } .spinner .rect3 { -webkit-animation-delay: -1.0s; animation-delay: -1.0s; } .spinner .rect4 { -webkit-animation-delay: -0.9s; animation-delay: -0.9s; } .spinner .rect5 { -webkit-animation-delay: -0.8s; animation-delay: -0.8s; } @-webkit-keyframes stretchdelay { 0%, 40%, 100% { -webkit-transform: scaleY(0.4) } 20% { -webkit-transform: scaleY(1.0) } } @keyframes stretchdelay { 0%, 40%, 100% { transform: scaleY(0.4); -webkit-transform: scaleY(0.4); } 20% {  transform: scaleY(1.0); -webkit-transform: scaleY(1.0); } }';\n\t\t\tzapi.loading_indicator_html   = '<div class=\"spinner\"><div class=\"rect1\"></div><div class=\"rect2\"></div><div class=\"rect3\"></div><div class=\"rect4\"></div><div class=\"rect5\"></div></div>';\n\t\t\tzapi.year_heading_styles      = '#boot .' + zapi.year_section_class + ' > h2 { margin-top: 20px; } #boot .' + zapi.year_section_class + '.first > h2 { margin-top: 0; }';\n\t\t\tzapi.year_filter_html         = '<nav class=\"year-filter c-accordion\"><div class=\"item\"><span class=\"group\"><h3>Archive <div class=\"arrow\"></div></h3>' + zapi.loading_indicator_html + '</span></div></nav>';\n\t\t\tzapi.year_filter_styles       = '.year-filter{width:30%;min-width:160px;float:right;margin-left:1em;margin-bottom:.5em}.year-filter .item{position:relative;max-height:50px;overflow:hidden;cursor:pointer}.year-filter.active .item{max-height:450px;overflow-y:auto;cursor:default}body.loading-references .year-filter.active .item{max-height:110px;overflow:hidden}.year-filter .spinner{position:static;margin:1em auto}.year-filter h3{cursor:pointer}.year-filter h6 a{display:block;padding:.2em 1em}.year-filter h6 a:hover{background:#f0f0f0}.year-filter h6 a.active,.year-filter h6 a.active:hover{background:#ddd}#boot .year-filter h6 a:hover{text-decoration:none}#boot .year-filter.active .item:hover{background-color:transparent}';\n\t\t},\n\t\tloadYearFilterList: function(evt) {\n\t\t\tevt.stopPropagation();\n\t\t\t// Add .active/.open\n\t\t\tzapi.yearFilterAddActive();\n\t\t\t\n\t\t\tif (!zapi.all_loaded) {\n\t\t\t\tif (zapi.load_all) {\n\t\t\t\t\t// Already working on it\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t// Load 'em up\n\t\t\t\tzapi.load_all = true;\n\t\t\t\t// Load max number of entries at a time\n\t\t\t\tzapi.params.num_entries = 99;\n\t\t\t\t// Set loading class\n\t\t\t\tzapi.$body.addClass(zapi.loading_class);\n\t\t\t\t// Kick off reference retrieval\n\t\t\t\tzapi.getReferences();\n\t\t\t}\n\t\t\t// Don't run this function again\n\t\t\tzapi.$body.off('click.year-filter.' + zapi.collection_name);\n\t\t\tzapi.$body.on('click.year-filter.' + zapi.collection_name, '.year-filter', zapi.yearFilterToggle);\n\t\t\tzapi.$body.on('click.year-filter.' + zapi.collection_name, '.year-filter h3', zapi.yearFilterTitleToggle);\n\t\t},\n\t\tyearFilterToggle: function(evt) {\n\t\t\tevt.stopPropagation();\n\t\t\t// Add .active/.open\n\t\t\tzapi.yearFilterAddActive();\n\n\t\t\t// Recalculate iframe height after 0.5 seconds\n\t\t\twindow.setTimeout(function() {\n\t\t\t\tzapi.$window.trigger('resize.tabs.' + zapi.collection_name);\n\t\t\t}, 500);\n\t\t},\n\t\tyearFilterTitleToggle: function(evt) {\n\t\t\tevt.stopPropagation();\n\t\t\t// Toggle .active/.open\n\t\t\tzapi.yearFilterToggleActive();\n\t\t\t\n\t\t\t// Recalculate iframe height after 0.5 seconds\n\t\t\twindow.setTimeout(function() {\n\t\t\t\tzapi.$window.trigger('resize.tabs.' + zapi.collection_name);\n\t\t\t}, 500);\n\t\t},\n\t\tyearFilterAddActive: function($year_filter) {\n\t\t\t$year_filter = $year_filter || zapi.$body.find('.year-filter');\n\t\t\tif (!$year_filter.hasClass('active')) {\n\t\t\t\t$year_filter.addClass('active');\n\t\t\t\t$year_filter.find('.item').addClass('open');\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn false;\n\t\t},\n\t\tyearFilterToggleActive: function($year_filter) {\n\t\t\t$year_filter = $year_filter || zapi.$body.find('.year-filter');\n\t\t\tif (!zapi.yearFilterAddActive($year_filter)) {\n\t\t\t\t$year_filter.removeClass('active');\n\t\t\t\t$year_filter.find('.item').removeClass('open');\n\t\t\t}\n\t\t}\n\t};\n\n\t// Suggested approach\n\t// 1. Parse responseData.xmlString of response into a document tree and wrap it with jQuery\n\t// var $resp = $($.parseXML(resp.responseData.xmlString));\n\t// 2. Loop through the entries using .each(); if necessary, fall back to the JSON using resp.responseData.feed.entries[idx] (shouldn't be necessary)\n\t// $resp.find('entry').each(function(idx) {});\n\n\t// Export our Zotero API handler\n\twindow.zotero_api = zapi;\n\t\n\t// Attach jquery.inview to parent if not yet attached\n\tif ($.event.special.inview === undefined) {\n\t\tjs_plugin_src = window.location.href.split('/');\n\t\tjs_plugin_src.pop();\n\t\tjs_plugin_src.push('jquery.inview.min.js');\n\t\tzapi.$parent_body.append('<script src=\"' + js_plugin_src.join('/') + '\"><\\/script>');\n\t}\n})(window.jQuery || window.parent.jQuery);\n"]}